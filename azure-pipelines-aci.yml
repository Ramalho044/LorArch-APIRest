trigger:
  branches:
    include:
      - master
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  appName: 'myassist554611'
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'
  resourceGroup: 'LorArch'
  location: 'eastus'

stages:
# =========================
# CI: build + testes + artefato + imagem
# =========================
- stage: Build
  displayName: 'CI - Build, Test, Docker build/push'
  jobs:
    - job: ci
      displayName: 'Gradle build & test'
      steps:
        - checkout: self
          fetchDepth: 1

        - task: UseJavaVersion@1
          inputs:
            versionSpec: '21'
            architecture: 'x64'
            jdkSourceOption: 'PreInstalled'

        - task: Cache@2
          displayName: 'Cache Gradle'
          inputs:
            key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
            restoreKeys: 'gradle | "$(Agent.OS)"'
            path: ~/.gradle/caches

        - script: chmod +x ./gradlew
          displayName: 'Permissão gradlew'

        - script: ./gradlew test --no-daemon
          displayName: 'Testes unitários'

        - script: ./gradlew bootJar --no-daemon
          displayName: 'Build JAR'

        - bash: |
            set -e
            JAR=$(ls build/libs/*.jar | head -n1)
            mkdir -p drop
            cp "$JAR" drop/app.jar
          displayName: 'Preparar artefato app.jar'

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'drop'
            artifactName: 'drop'
          displayName: 'Publicar artefato (app.jar)'

        - task: Docker@2
          displayName: 'Docker build & push para ACR'
          inputs:
            containerRegistry: '$(dockerRegistryServiceConnection)'
            repository: '$(imageRepository)'
            command: 'buildAndPush'
            Dockerfile: 'Dockerfile'
            buildContext: '.'
            tags: |
              $(Build.BuildId)
            arguments: '--build-arg JAR_FILE=drop/app.jar'

# =========================
# CD: deploy no ACI + health-check
# =========================
- stage: Deploy
  displayName: 'CD - Deploy no Azure Container Instance'
  dependsOn: Build
  condition: succeeded()
  jobs:
    - job: deploy
      displayName: 'Criar/Atualizar ACI'
      steps:
        - task: DownloadBuildArtifacts@1
          displayName: 'Baixar artefato (caso queira validar)'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'drop'
            downloadPath: '$(Pipeline.Workspace)'

        - task: AzureCLI@2
          displayName: 'Deploy no ACI + health-check'
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              set -e

              echo "Login no ACR..."
              az acr login --name $(acrName)

              IMAGE="$(acrLoginServer)/$(imageRepository):$(Build.BuildId)"
              DNS_LABEL="$(echo $(appName) | tr '[:upper:]' '[:lower:]')"

              echo "Criando/atualizando container $(appName) com imagem ${IMAGE}"
              # cria ou atualiza (delete/replace se já existir)
              if az container show -g $(resourceGroup) -n $(appName) &>/dev/null; then
                az container delete -g $(resourceGroup) -n $(appName) --yes
              fi

              az container create \
                --name $(appName) \
                --resource-group $(resourceGroup) \
                --location $(location) \
                --image ${IMAGE} \
                --cpu 1 \
                --memory 1.5 \
                --dns-name-label ${DNS_LABEL} \
                --ports 8080 \
                --restart-policy Always \
                --environment-variables DB_URL=$(DB_URL) DB_USER=$(DB_USER) \
                --secure-environment-variables DB_PASSWORD=$(DB_PASSWORD) \
                --registry-login-server $(acrLoginServer)

              echo "Aguardando iniciar..."
              for i in {1..30}; do
                STATE=$(az container show -g $(resourceGroup) -n $(appName) --query "instanceView.state" -o tsv)
                echo "Estado: $STATE"
                [ "$STATE" = "Running" ] && break
                sleep 7
              done

              FQDN=$(az container show -g $(resourceGroup) -n $(appName) --query "ipAddress.fqdn" -o tsv)
              echo "FQDN: $FQDN"

              echo "Health-check em http://$FQDN:8080/actuator/health"
              for i in {1..30}; do
                code=$(curl -s -o /dev/null -w "%{http_code}" "http://$FQDN:8080/actuator/health" || true)
                echo "Tentativa $i - HTTP $code"
                [ "$code" = "200" ] && echo "Health OK" && exit 0
                sleep 7
              done

              echo "Health-check falhou."
              # logs de diagnóstico
              az container logs -g $(resourceGroup) -n $(appName) || true
              exit 1
