trigger:
  branches:
    include:
      - master
      - main

pool:
  vmImage: 'ubuntu-latest'

name: $(Date:yyyyMMdd).$(Rev:r)

variables:
  appName: 'lorarch-app'
  resourceGroup: 'LorArch'
  location: 'eastus'
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/lorarch'
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'

stages:
- stage: CI
  displayName: 'CI — Build, Test, Jacoco, Docker build & Push'
  jobs:
    - job: build
      displayName: 'Job: Build & Test Java'
      steps:
        - checkout: self
        - task: JavaToolInstaller@0
          inputs:
            versionSpec: '21'
            jdkArchitectureOption: 'x64'
            jdkSourceOption: 'PreInstalled'
          displayName: 'Instalar Java 21'

        - task: Cache@2
          inputs:
            key: 'gradle | "$(Agent.OS)" | **/gradle-wrapper.properties'
            restoreKeys: gradle | "$(Agent.OS)"
            path: ~/.gradle
          displayName: 'Cache Gradle'

        - script: ./gradlew clean test jacocoTestReport --no-daemon
          displayName: 'Rodar Testes (sem SQL)'
          env:
            SPRING_PROFILES_ACTIVE: 'ci'

        - script: ./gradlew bootJar --no-daemon
          displayName: 'Gerar artefato JAR'

        - bash: |
            set -e
            JAR=$(ls build/libs/*.jar | head -n1)
            mkdir -p drop
            cp "$JAR" drop/app.jar
          displayName: 'Preparar artefato para Docker'

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'drop'
            artifactName: 'drop'

        - task: Docker@2
          displayName: 'Build & Push imagem Docker → ACR'
          inputs:
            containerRegistry: '$(dockerRegistryServiceConnection)'
            repository: '$(imageRepository)'
            command: 'buildAndPush'
            Dockerfile: 'Dockerfile'
            buildContext: '$(System.DefaultWorkingDirectory)'
            tags: |
              $(Build.BuildId)
              latest

- stage: CD
  displayName: 'CD — Deploy no ACI'
  dependsOn: CI
  condition: succeeded()
  jobs:
    - job: deploy
      steps:
        - task: AzureCLI@2
          displayName: 'Deploy container ACI'
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -e
              IMAGE="$(acrLoginServer)/$(imageRepository):$(Build.BuildId)"
              DNS_LABEL="$(echo $(appName) | tr '[:upper:]' '[:lower:]')"

              az container create \
                --name $(appName) \
                --resource-group $(resourceGroup) \
                --location $(location) \
                --image ${IMAGE} \
                --os-type Linux \
                --cpu 1 --memory 1.5 \
                --restart-policy Always \
                --ports 8080 \
                --dns-name-label ${DNS_LABEL} \
                --registry-login-server $(acrLoginServer) \
                --registry-username $(ACR_USER) \
                --registry-password $(ACR_PASS)
