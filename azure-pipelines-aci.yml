# =========================
# Azure DevOps Pipeline – CI/CD
# Build Docker + Push ACR + Deploy ACI + Health Check
# =========================

trigger:
  branches:
    include:
      - master
      - main

name: $(Date:yyyyMMdd).$(Rev:r)

pool:
  vmImage: 'ubuntu-latest'

# Variáveis da pipeline (não duplique este bloco em outro lugar do YAML)
variables:
  appName: 'myassist554611'               # nome do container/hostname
  resourceGroup: 'LorArch'
  location: 'eastus'
  port: '8080'

  # ACR
  acrName: 'acrlorch'
  acrLoginServer: 'acrlorch.azurecr.io'
  imageRepository: 'fiap/$(appName)'
  imageTag: '$(Build.BuildId)'

  # Service Connections (já criados no projeto)
  dockerRegistryServiceConnection: 'sc-acr-lorch'
  azureServiceConnection: 'sc-azure-lorch'

stages:
# ====================================================
# STAGE 1 — Build da imagem e Push para o ACR (CI)
# ====================================================
- stage: Build
  displayName: 'Build & Push para ACR'
  jobs:
    - job: docker_build_push
      displayName: 'Gerar e enviar imagem Docker'
      steps:
        - task: Docker@2
          displayName: 'Docker buildAndPush'
          inputs:
            containerRegistry: '$(dockerRegistryServiceConnection)'
            repository: '$(imageRepository)'
            command: 'buildAndPush'
            Dockerfile: '**/Dockerfile'
            tags: |
              $(imageTag)

        # publica um artefato "image_meta" só para deixar rastreável
        - publish: $(Pipeline.Workspace)
          artifact: image_meta
          displayName: 'Publicar metadados de imagem (opcional)'
          condition: always()

# ====================================================
# STAGE 2 — Deploy no Azure Container Instances (CD)
# ====================================================
- stage: Deploy
  displayName: 'Deploy no Azure Container Instance'
  dependsOn: Build
  condition: succeeded('Build')
  jobs:
    - job: aci_deploy
      displayName: 'Criar/atualizar ACI'
      steps:
        - task: AzureCLI@2
          displayName: 'az container create'
          inputs:
            azureSubscription: '$(azureServiceConnection)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -euo pipefail

              IMG="$(acrLoginServer)/$(imageRepository):$(imageTag)"
              echo "Imagem: $IMG"

              echo "Login no ACR"
              az acr login --name $(acrName)

              echo "Garantir Resource Group"
              az group create -n $(resourceGroup) -l $(location) --only-show-errors 1>/dev/null

              echo "Remover container anterior (se existir)"
              if az container show -g $(resourceGroup) -n $(appName) &>/dev/null; then
                az container delete -g $(resourceGroup) -n $(appName) --yes
              fi

              echo "Criar ACI"
              az container create \
                -g $(resourceGroup) \
                -n $(appName) \
                --image "$IMG" \
                --cpu 1 \
                --memory 1.5 \
                --os-type Linux \
                --registry-login-server $(acrLoginServer) \
                --assign-identity \
                --dns-name-label $(appName) \
                --ports $(port) \
                --environment-variables \
                  DB_URL="$(DB_URL)" \
                  DB_USER="$(DB_USER)" \
                  DB_PASSWORD="$(DB_PASSWORD)"

              echo "Aguardar ACI em Running"
              az container wait -g $(resourceGroup) -n $(appName) \
                --custom "instanceView.state=='Running'" \
                --interval 10 --timeout 600

              echo "Health check (30 tentativas)"
              for i in {1..30}; do
                if curl -fsS "http://$(appName).$(location).azurecontainer.io:$(port)/actuator/health" | grep -q '"status":"UP"'; then
                  echo "Saúde OK";
                  exit 0
                fi
                echo "Aguardando saúde... tent $i"; sleep 7
              done

              echo "Health check falhou. Logs do container:"
              az container logs -g $(resourceGroup) -n $(appName) || true
              exit 1
